# !/bin/python
# -*- coding: utf-8 -*-
u"""SecureTea Social Engineering
Project:
    ╔═╗┌─┐┌─┐┬ ┬┬─┐┌─┐╔╦╗┌─┐┌─┐
    ╚═╗├┤ │  │ │├┬┘├┤  ║ ├┤ ├─┤
    ╚═╝└─┘└─┘└─┘┴└─└─┘ ╩ └─┘┴ ┴
    Author: Digvijay Bhosale <digvijayb1729@gmail.com> August 15 2021
    Version: 1.0
    Module: SecureTea
"""

import os
import json
import subprocess

from securetea.lib.malware_analysis.fileAnalysis import FileAnalyser
from securetea.lib.malware_analysis.malwareAnalysis import MalwareAnalysis
from securetea.lib.malware_analysis.continuous_malware_defence import ContinuousDefence
from securetea.lib.malware_analysis import globals
from securetea.lib.malware_analysis.mal_gui import app_runner


class SecureTeaMalwareAnalysis:
    def __init__(self, creds):
        self.mode = creds['mode']
        self.api_key = ''
        self.filename = ''
        globals.initialize_colours()

    def runner(self):
        if self.mode.lower() == 'i' or self.mode.lower() == 'm':
            while True:
                self.filename = input("Enter Filename\n\t:")
                if os.path.isfile(self.filename):
                    break
                else:
                    print(globals.WARNING + 'Given Filename does not exist. ' + globals.END)

        if self.mode.lower() == 'c' or self.mode.lower() == 'm':
            while True:
                c = input('Check API_KEY Validity? (y/N)') or 'N'
                if c.lower() == 'y':
                    while True:
                        api_key = input("Enter API_KEY\n\t:")
                        validity_code = self.check_api_key(api_key=api_key)
                        if validity_code == 0:
                            print("API KEY Valid")
                            self.api_key = api_key
                            break
                        elif validity_code == 1:
                            print("API KEY Invalid")
                        elif validity_code == 2:
                            print("secureta/lib/notifs/val_file/cat.jpg seems to be missing....\n"
                                  "If cat.jpg is missing, create a cat.jpg file (Download from the internet is easiest")
                        elif validity_code == 3:
                            print("Some unknown error occurred")
                        else:
                            print("This shouldn't happen")
                else:
                    print("Validity of API KEY will not be checked.")
                    self.api_key = input("Enter API_KEY\n\t:")

        if self.mode.lower() == 'c':
            GUI = True
            globals.initialize_flask()
            thread1 = ContinuousDefence(gui=GUI, API_KEY=self.api_key)

            # Start new Thread for MalwareAnalysis
            thread1.start()
            if GUI:
                app_runner()

            thread1.join()
        elif self.mode.lower() == 'i':
            f_analysis = FileAnalyser(self.filename)
            f_analysis.start_analysis()
        elif self.mode.lower() == 'm':
            self.api_key = input('Enter VirusTotal API Key\n\t:')
            m_analysis = MalwareAnalysis(filename=self.filename, API_KEY=self.api_key)
            m_analysis.runner()
        else:
            print("Incorrect option selected")
            return

    def check_api_key(self, api_key):
        API_KEY = api_key
        filename = 'val_file/cat.jpg'
        base_url = 'https://www.virustotal.com/api/v3/files'
        headers = 'x-apikey: ' + API_KEY
        file_path = '@' + filename

        process = subprocess.Popen(['curl', '--request', 'POST', '--url', base_url,
                                    '--header', headers,
                                    '--form', 'file=' + file_path],
                                   stdout=subprocess.PIPE,
                                   stderr=subprocess.PIPE)
        stdout, stderr = process.communicate()
        data = stdout.decode('utf-8')
        stderr = stderr.decode('utf-8')
        json_data = json.loads(data)
        # print(json_data.keys[1])
        if 'data' in json_data.keys():
            return 0
        elif 'error' in json_data.keys():
            if json_data['error']['code'] == 'WrongCredentialsError':
                return 1
            else:
                return 2
        else:
            return 3
        
